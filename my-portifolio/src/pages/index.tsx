import {
  createRef,
  forwardRef,
  useEffect,
  useImperativeHandle,
  useLayoutEffect,
  useRef,
  useState,
} from "react";
import Head from "next/head";
import {
  Header,
  Content,
  AboutMe,
  Experience,
  Schooling,
  Repositories,
} from "../components/export";
import { gsap } from "gsap";
import debounce from "./Controllers/debounce";

export default function Home() {
  const [activeTab, setActiveTab] = useState("welcome");
  const [scrollFocus, setScrollFocus] = useState<boolean>(true);
  const [scrollPagination, setScrollPagination] = useState<number>(0);
  const itemsRef = useRef<HTMLDivElement>(null);

  const handleActiveTab = (tab: string) => {
    setActiveTab(tab);

    if (tab === "Perfil") {
      setScrollPagination(1);
    } else if (tab === "Experiencias") {
      setScrollPagination(2);
    } else if (tab === "Escolaridade") {
      setScrollPagination(3);
    } else if (tab === "Projetos") {
      setScrollPagination(4);
    }
  };

  useEffect(() => {
    let prevScrollPosition = window.pageYOffset;
    const debouncedFn = debounce(() => {
      const currentScrollPosition = window.pageYOffset;

      if (scrollPagination >= 0 && scrollPagination <= 4) {
        if (currentScrollPosition > prevScrollPosition) {
          setScrollFocus(true);
          setScrollPagination(scrollPagination + 1);
          return;
        } else {
          setScrollFocus(false);
          setScrollPagination(scrollPagination - 1);
          return;
        }
      }
    }, 25);

    window.addEventListener("scroll", debouncedFn);
    return () => {
      window.removeEventListener("scroll", debouncedFn);
    };
  }, [scrollPagination]);

  useEffect(() => {
    const items = itemsRef.current?.children;

    if (items && scrollPagination >= 0 && scrollPagination < 5) {
      Array.from(items).forEach((item, index) => {
        const obj = {
          opacity: 1,
          x: 0,
          duration: 2,
          delay: 0.2,
          ease: "power3.out",
        };

        const obj2 = {
          opacity: 0,
          x: -100,
          duration: 1,
          delay: 0.2,
          ease: "power3.out",
        };

        console.log("scrollPagination: " + scrollPagination);
        let element = item;

        gsap.to(element, obj2);
        // item.classList.add("hidden");

        if (scrollPagination === 0) {
          element = items[scrollPagination];
          setActiveTab("welcome");
        } else if (scrollPagination === 1) {
          setActiveTab("Perfil");
          element = items[scrollPagination];
        } else if (scrollPagination === 2) {
          setActiveTab("Experiencias");
          element = items[scrollPagination];
        } else if (scrollPagination === 3) {
          setActiveTab("Escolaridade");
          element = items[scrollPagination];
        } else if (scrollPagination === 4) {
          setActiveTab("Projetos");
          element = items[scrollPagination];
        }

        element.classList.remove("hidden");

        gsap.to(element, obj);
      });
    } else {
      setScrollPagination(0);
      setScrollFocus(true);
      window.scroll(0, 0);
    }
  }, [scrollPagination]);

  return (
    <>
      <Head>
        <title>Portifolio</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        {/* <link rel="icon" href="/favicon.ico" /> */}
      </Head>
      <Header activeTab={activeTab} onClick={handleActiveTab} />
      <main className="h-screen">
        <div
          style={{ height: "1050px" }}
          className=" flex flex-col items-center"
          ref={itemsRef}
        >
          <Content
            className={`bg-welcome`}
            title={`BEM VINDO AO MEU PORTIFOLIO`}
          />

          <Content className={`bg-content-1`} title={`Sobre mim`}>
            <AboutMe />
          </Content>

          <Content className={`bg-content-2`} title={`Experiencias`}>
            <Experience />
          </Content>

          <Content className={`bg-content-3`} title={`Escolaridade`}>
            <Schooling />
          </Content>

          <Content className={`bg-content-4`} title={`Projetos`}>
            <Repositories />
          </Content>
        </div>
      </main>
    </>
  );
}
